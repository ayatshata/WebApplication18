@{
    ViewData["Title"] = "لوحة التحكم";
}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - دار المغتربات</title>

    <!-- مكتبات CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet" />

    <!-- CSS مخصص RTL -->
    <link href="~/css/site-rtl.css" rel="stylesheet" />
</head>
<body id="page-top">
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav sidebar sidebar-dark accordion" id="accordionSidebar">
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
                <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-home"></i></div>
                <div class="sidebar-brand-text mx-3">بيت المغتربات</div>
            </a>
            <hr class="sidebar-divider my-0 bg-light">
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Dashboard" ? "active" : "")">
                <a class="nav-link" href="/Dashboard"><i class="fas fa-fw fa-tachometer-alt"></i><span>لوحة التحكم</span></a>
            </li>
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Residents" ? "active" : "")">
                <a class="nav-link" href="/Residents"><i class="fas fa-fw fa-users"></i><span>المقيمين</span></a>
            </li>
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Payments" ? "active" : "")">
                <a class="nav-link" href="/Payments"><i class="fas fa-fw fa-dollar-sign"></i><span>المدفوعات</span></a>
            </li>
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Maintenance" ? "active" : "")">
                <a class="nav-link" href="/Maintenance"><i class="fas fa-fw fa-tools"></i><span>الصيانة</span></a>
            </li>
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Reports" ? "active" : "")">
                <a class="nav-link" href="/Reports"><i class="fas fa-fw fa-chart-bar"></i><span>التقارير</span></a>
            </li>
            <li class="nav-item @(ViewData["ActivePage"]?.ToString() == "Notifications" ? "active" : "")">
                <a class="nav-link" href="/Notifications"><i class="fas fa-fw fa-bell"></i><span>الإشعارات</span></a>
            </li>
        </ul>

        <!-- محتوى الصفحة -->
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <nav class="navbar navbar-expand navbar-light topbar mb-4 static-top shadow">
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3"><i class="fa fa-bars"></i></button>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a class="nav-link" href="#"><i class="fas fa-bell fa-fw"></i><span class="badge bg-danger" id="notificationCount">0</span></a>
                        </li>
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a class="nav-link" href="#" id="clearNotificationsBtn"><i class="fas fa-trash-alt"></i></a>
                        </li>
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown">
                                <span class="me-2 text-gray-600 small" id="userName">مستخدم</span>
                                <img class="img-profile rounded-circle" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" />
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="container-fluid">
                    @RenderBody()
                </div>
            </div>

            <footer class="sticky-footer">
                <div class="container my-auto text-center">
                    <span>جميع الحقوق محفوظة للمطورة آيات علي © دار المغتربات @DateTime.Now.Year</span>
                </div>
            </footer>
        </div>
    </div>

    <!-- مكتبات JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        // إعداد SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .build();

        connection.on("ReceiveNotification", function(message) {
            const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            playNotificationSound();
            showNotification(message, time);
            saveNotification(message, time);
            updateCount();
        });

        connection.start().catch(err => console.error("❌ SignalR Error:", err));

        function showNotification(message, time) {
            const alert = document.createElement("div");
            alert.className = "notification-bar";
            alert.innerHTML = `<i class="fas fa-bell me-2"></i> ${message}
                               <div class="notification-time"><i class="far fa-clock"></i> ${time}</div>`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 6000);
        }

        function playNotificationSound() {
            const audio = new Audio('https://www.myinstants.com/media/sounds/bell.mp3');
            audio.play();
        }

        function saveNotification(msg, time) {
            let notifs = JSON.parse(localStorage.getItem("notifications") || "[]");
            notifs.unshift({ msg, time });
            if (notifs.length > 10) notifs.pop();
            localStorage.setItem("notifications", JSON.stringify(notifs));
        }

        window.addEventListener("load", () => {
            const saved = JSON.parse(localStorage.getItem("notifications") || "[]");
            saved.slice(0,3).forEach(n => showNotification(n.msg, n.time));
            updateCount(saved.length);
        });

        function updateCount(num) {
            const countEl = document.getElementById("notificationCount");
            const stored = JSON.parse(localStorage.getItem("notifications") || "[]");
            countEl.textContent = num || stored.length;
        }

        document.getElementById("clearNotificationsBtn").addEventListener("click", () => {
            localStorage.removeItem("notifications");
            document.querySelectorAll(".notification-bar").forEach(n => n.remove());
            updateCount(0);
        });
    </script>
</body>
</html>
